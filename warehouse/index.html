<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AIP 宝可梦精灵租借中心 / Pokémon Rental Center</title>
    <style>
        :root{
            --bg:#f6f8fa; --card:#fff; --muted:#6b7280;
            --green:#059669; --red:#dc2626; --accent:#0ea5e9;
            font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
        }
        body{margin:18px;background:var(--bg);color:#111}
        .wrap{max-width:1100px;margin:0 auto}
        header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
        h1{font-size:18px;margin:0}
        .controls{display:flex;gap:8px;align-items:center}
        button{background:var(--card);border:1px solid #e6e9ef;padding:8px 12px;border-radius:8px;cursor:pointer;min-width:64px}
        button.active{border-color:var(--accent);box-shadow:0 0 0 3px rgba(14,165,233,0.12)}
        input.search{background:var(--card);border:1px solid #e6e9ef;padding:8px 12px;border-radius:8px;min-width:180px}
        .card{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 1px 2px rgba(16,24,40,0.04)}
        .stats{display:flex;gap:18px;align-items:center;font-size:14px}
        .stats .item{color:var(--muted)}
        .stats .value{font-weight:700;color:#111;margin-left:6px}
        table{width:100%;border-collapse:collapse;font-size:13px}
        thead th{background:#f3f5f7;text-align:left;padding:10px;border-bottom:1px solid #e6e9ef}
        tbody td{padding:10px;border-bottom:1px solid #f1f3f5;vertical-align:middle}
        .idx{width:48px;text-align:center;color:var(--muted)}
        .name{font-weight:600}
        .muted{color:var(--muted);font-size:12px}
        .badge{display:inline-block;padding:6px 10px;border-radius:999px;color:#fff;font-weight:600;font-size:12px}
        .available{background:var(--green)}
        .unavailable{background:var(--red)}
        .small{font-size:12px;color:var(--muted)}
        @media (max-width:860px){
            /* 整体改为卡片列表，显示每列的标签（使用 td[data-label]） */
            body{margin:12px}
            h1{font-size:16px}
            header{flex-direction:column;align-items:flex-start;gap:8px}
            .controls{flex-wrap:wrap}
            button{padding:10px 14px;border-radius:10px;min-width:80px}
            input.search{min-width:100%}
            table, thead, tbody, th, td, tr{display:block}
            thead{display:none}
            tr{margin-bottom:12px;border-radius:8px;background:#fff;padding:12px;position:relative}
            tbody td{border:none;padding:6px 10px 6px 12px;display:block;position:relative}
            /* 在每个单元格前显示标签（除索引列） */
            tbody td:not(.idx)::before{
                content: attr(data-label);
                display:block;
                font-weight:600;
                color:var(--muted);
                margin-bottom:6px;
                font-size:12px;
                white-space:nowrap;
                overflow:hidden;
                text-overflow:ellipsis;
            }
            .idx{position:absolute;right:12px;top:12px;background:transparent;width:auto;text-align:right;padding:0}
            .name{font-size:15px}
            .badge{font-size:12px;padding:6px 10px}
            .card{padding:10px}
            /* 减少行内拥挤，增加点击目标 */
            td, button{touch-action:manipulation}
        }
    </style>
</head>
<body>
    <div class="wrap">

        <header>
            <h1>AIP宝可梦精灵租借中心 / AIP Pokémon Rental Center</h1>
            <div class="controls">
                <div class="small">显示语言 / Language:</div>
                <button id="btn-zh" class="active">中文 (ZH)</button>
                <button id="btn-en">English (EN)</button>

                <div style="width:12px"></div>

                <div class="small" style="margin-right:6px">搜索 / Search:</div>
                <input id="search" class="search" type="search" placeholder="按名称搜索 / Search by name" aria-label="Search by name">
            </div>
        </header>

        <!-- 新增：规则说明 TIPS（支持中英双语，由脚本切换内容） -->
        <div id="tips" class="card" style="margin-bottom:12px;font-size:12px"></div>

        <!-- 新增：统计信息 -->
        <div id="stats" class="card" style="margin-bottom:12px"></div>

        <div class="card" id="table-card">
            <table id="pokemon-table" aria-describedby="说明">
                <thead id="table-head"></thead>
                <tbody id="table-body"></tbody>
            </table>
            
        </div>
    </div>

    <script>
        // GitHub Copilot
        // 页面会尝试 fetch 同目录下 data.csv，格式为 CSV，有表头（见注释）。
        // 如果 fetch 失败，会使用下面的示例数据作为回退。

        const fallbackData = [
            {
                id: "1",
                name_cn: "皮卡丘",
                name_en: "Pikachu",
                config_cn: "电属性，擅长十万伏特，速度优秀",
                config_en: "Electric type, excels at Thunderbolt, high speed",
                available: "yes",
                renter: "",
                time: "",
                collateral: "皮蛋一本",
                donor: "Ash"
            },
            {
                id: "2",
                name_cn: "喷火龙",
                name_en: "Charizard",
                config_cn: "火/飞行，强力特攻，能喷射烈焰",
                config_en: "Fire/Flying, strong special attack, can emit powerful flames",
                available: "no",
                renter: "小智",
                time: "2025-08-12 14:30",
                collateral: "稀有石头",
                donor: "Charm"
            },
            {
                id: "3",
                name_cn: "妙蛙种子",
                name_en: "Bulbasaur",
                config_cn: "草/毒，耐久佳，擅长种子机关",
                config_en: "Grass/Poison, good bulk, skilled with seed moves",
                available: "yes",
                renter: "",
                time: "",
                collateral: "一包肥料",
                donor: "Misty"
            }
        ];

        const LANG = { zh: "zh", en: "en" };
        let currentLang = LANG.zh;

        const headLabels = {
            id: { zh: "序号", en: "#" },
            name: { zh: "宝可梦", en: "Pokémon" },
            config: { zh: "配置信息 / 详细描述", en: "Configuration / Details" },
            available: { zh: "当前是否在仓库", en: "In Warehouse" },
            renter: { zh: "租借人", en: "Renter" },
            time: { zh: "租借时间", en: "Rent Time" },
            collateral: { zh: "抵押物", en: "Collateral" },
            donor: { zh: "捐献人", en: "Donor" }
        };

        const statsLabels = {
            total: { zh: "总数", en: "Total" },
            available: { zh: "在库", en: "Available" },
            borrowed: { zh: "已借出", en: "Borrowed" }
        };

        // TIPS 文本（中英）
        const tipsText = {
            zh: '<strong>使用须知 TIPS：</strong>需要租借宝可梦请联系Rong；请在租借后一星期内归还宝可梦；请妥善保管禁止转借他人；归还后抵押物将返还；归还时请还原配置；每人最多可租借三只宝可梦',
            en: '<strong>Rules / TIPS:</strong> For Pokemon rentals, please contact Rong; Please return the Pokémon within one week of rental. Please handle with care and do not lend to others. Deposit will be refunded upon return. Please restore original configuration when returning. Maximum of 3 Pokémon per person.'
        };

        const tableHeadEl = document.getElementById("table-head");
        const tableBodyEl = document.getElementById("table-body");
        const btnZh = document.getElementById("btn-zh");
        const btnEn = document.getElementById("btn-en");
        const searchInput = document.getElementById("search");
        const tipsEl = document.getElementById("tips");
        const statsEl = document.getElementById("stats");

        btnZh.addEventListener("click", () => setLang(LANG.zh));
        btnEn.addEventListener("click", () => setLang(LANG.en));

        function setLang(lang){
            currentLang = lang;
            btnZh.classList.toggle("active", lang === LANG.zh);
            btnEn.classList.toggle("active", lang === LANG.en);
            // 更新头部、提示和表格
            renderHead();
            tipsEl.innerHTML = tipsText[lang] || "";
            renderBody(getFilteredData());
            renderStats();
        }

        function renderHead(){
            tableHeadEl.innerHTML = "";
            const tr = document.createElement("tr");
            const keys = ["id","name","config","available","renter","time","collateral","donor"];
            keys.forEach(k=>{
                const th = document.createElement("th");
                th.textContent = headLabels[k][currentLang];
                tr.appendChild(th);
            });
            tableHeadEl.appendChild(tr);
        }

        function interpretAvailable(val){
            if(!val) return false;
            val = String(val).trim().toLowerCase();
            return ["1","yes","true","available","在库","y","in"].includes(val);
        }

        function escapeHtml(s){
            if(s == null) return "";
            return String(s)
                .replace(/&/g,"&amp;")
                .replace(/</g,"&lt;")
                .replace(/>/g,"&gt;");
        }

        function renderBody(data){
            tableBodyEl.innerHTML = "";
            const keysOrder = ["id","name","config","available","renter","time","collateral","donor"];
            data.forEach((row,i)=>{
                const tr = document.createElement("tr");

                // id
                const tdId = document.createElement("td");
                tdId.className = "idx";
                tdId.textContent = row.id || (i+1);
                tdId.setAttribute("data-label", headLabels["id"][currentLang]);
                tr.appendChild(tdId);

                // name (choose language field)
                const tdName = document.createElement("td");
                tdName.className = "name";
                const nameVal = currentLang === LANG.zh ? (row.name_cn || row.name_en) : (row.name_en || row.name_cn);
                tdName.innerHTML = escapeHtml(nameVal);
                tdName.setAttribute("data-label", headLabels["name"][currentLang]);
                tr.appendChild(tdName);

                // config
                const tdCfg = document.createElement("td");
                tdCfg.innerHTML = escapeHtml(currentLang === LANG.zh ? (row.config_cn || row.config_en) : (row.config_en || row.config_cn));
                tdCfg.setAttribute("data-label", headLabels["config"][currentLang]);
                tr.appendChild(tdCfg);

                // available
                const tdAvail = document.createElement("td");
                const isAvail = interpretAvailable(row.available);
                const span = document.createElement("span");
                span.className = "badge " + (isAvail ? "available" : "unavailable");
                span.textContent = isAvail ? (currentLang===LANG.zh ? "在库" : "In Stock") : (currentLang===LANG.zh ? "已借出" : "Checked Out");
                tdAvail.appendChild(span);
                tdAvail.setAttribute("data-label", headLabels["available"][currentLang]);
                tr.appendChild(tdAvail);

                // renter
                const tdRenter = document.createElement("td");
                tdRenter.textContent = row.renter || (currentLang===LANG.zh ? "—" : "—");
                tdRenter.setAttribute("data-label", headLabels["renter"][currentLang]);
                tr.appendChild(tdRenter);

                // time
                const tdTime = document.createElement("td");
                tdTime.textContent = row.time || (currentLang===LANG.zh ? "—" : "—");
                tdTime.setAttribute("data-label", headLabels["time"][currentLang]);
                tr.appendChild(tdTime);

                // collateral
                const tdColl = document.createElement("td");
                tdColl.textContent = row.collateral || "—";
                tdColl.setAttribute("data-label", headLabels["collateral"][currentLang]);
                tr.appendChild(tdColl);

                // donor
                const tdDonor = document.createElement("td");
                tdDonor.textContent = row.donor || "—";
                tdDonor.setAttribute("data-label", headLabels["donor"][currentLang]);
                tr.appendChild(tdDonor);

                tableBodyEl.appendChild(tr);
            });
        }

        function renderStats(){
            const total = lastData.length;
            const avail = lastData.filter(r => interpretAvailable(r.available)).length;
            const borrowed = total - avail;
            // 使用当前语言显示
            const tLabel = statsLabels.total[currentLang];
            const aLabel = statsLabels.available[currentLang];
            const bLabel = statsLabels.borrowed[currentLang];
            statsEl.innerHTML = `
                <div class="stats">
                    <div class="item">${tLabel}: <span class="value">${total}</span></div>
                    <div class="item">${aLabel}: <span class="value">${avail}</span></div>
                    <div class="item">${bLabel}: <span class="value">${borrowed}</span></div>
                </div>
            `;
        }

        // Simple CSV parser supporting quoted fields with commas
        function parseCSV(text){
            const lines = text.split(/\r\n|\n/).filter(l => l.trim() !== "");
            if(lines.length === 0) return [];
            const parseLine = (line) => {
                const res = [];
                let cur = "", inQuotes = false;
                for(let i=0;i<line.length;i++){
                    const ch = line[i];
                    if(ch === '"' ){
                        if(inQuotes && line[i+1]==='"'){ cur += '"'; i++; } // escaped quote
                        else inQuotes = !inQuotes;
                    } else if(ch === ',' && !inQuotes){
                        res.push(cur);
                        cur = "";
                    } else cur += ch;
                }
                res.push(cur);
                return res.map(s => s.trim());
            };
            const headers = parseLine(lines[0]).map(h => h.replace(/\ufeff/g,'').trim());
            const rows = [];
            for(let i=1;i<lines.length;i++){
                const cols = parseLine(lines[i]);
                // skip empty lines
                if(cols.length === 1 && cols[0] === "") continue;
                const obj = {};
                for(let j=0;j<headers.length;j++){
                    obj[headers[j]] = cols[j] !== undefined ? cols[j] : "";
                }
                rows.push(obj);
            }
            return rows;
        }

        let lastData = [];
        let searchTerm = "";

        function getFilteredData(){
            if(!searchTerm) return lastData;
            const s = searchTerm.toLowerCase();
            return lastData.filter(r => {
                const a = (r.name_cn || "").toLowerCase();
                const b = (r.name_en || "").toLowerCase();
                const c = (r.renter || "").toLowerCase();
                return a.includes(s) || b.includes(s) || c.includes(s);
            });
        }

        // debounce helper
        function debounce(fn, wait){
            let t;
            return function(...args){
                clearTimeout(t);
                t = setTimeout(()=> fn.apply(this, args), wait);
            };
        }

        searchInput.addEventListener("input", debounce(() => {
            searchTerm = searchInput.value.trim();
            renderBody(getFilteredData());
            // 可选：也可以让统计反映筛选结果，当前显示为总计
            // 如果想让统计随筛选变化，把下面一行改为 renderStatsFiltered();
        }, 200));

        function loadData(){
            fetch("data.csv", {cache: "no-cache"})
                .then(resp => {
                    if(!resp.ok) throw new Error("no file");
                    return resp.arrayBuffer();
                })
                .then(buffer => {
                    // Decode as UTF-8 first and strip BOM; if replacement chars appear, try GBK (may not be supported in all browsers)
                    let text = "";
                    try{
                        text = new TextDecoder("utf-8").decode(buffer);
                    }catch(e){
                        text = "";
                    }
                    if(text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
                    if(text.includes("\uFFFD") && typeof TextDecoder === "function"){
                        try{
                            text = new TextDecoder("gbk").decode(buffer);
                        }catch(e){
                            // ignore if GBK not supported
                        }
                    }
                    return text;
                })
                .then(text => {
                    try{
                        const parsed = parseCSV(text);
                        if(parsed.length === 0) throw new Error("empty");
                        lastData = parsed;
                        renderBody(getFilteredData());
                        renderStats();
                    }catch(e){
                        lastData = fallbackData;
                        renderBody(getFilteredData());
                        renderStats();
                    }
                })
                .catch(err => {
                    // fallback
                    lastData = fallbackData;
                    renderBody(getFilteredData());
                    renderStats();
                });
        }

        // init
        renderHead();
        setLang(currentLang);
        loadData();

        // Optional: auto-refresh every 60s to reflect changes in data.csv
        //setInterval(loadData, 60_000);
    </script>

    <!--
    示例 data.csv（放在与 index.html 同一目录下，UTF-8，无 BOM）:
    id,name_cn,name_en,config_cn,config_en,available,renter,time,collateral,donor
    1,皮卡丘,Pikachu,电属性，擅长十万伏特，速度优秀,Electric type, excels at Thunderbolt, high speed,yes,,,"皮蛋一本",Ash
    2,喷火龙,Charizard,火/飞行，强力特攻,Fire/Flying, strong special attack,no,小智,2025-08-12 14:30,稀有石头,Charm

    编辑 data.csv 来维护表格内容，保存后页面将在 60 秒内自动更新（或手动刷新）。
    -->
</body>
</html>